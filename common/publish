#!/bin/bash
#
set -e

source ./setup_environment

export PUBLISH_COMMON_DIR=../common/

echo "Getting images from the deploy archive."
${PUBLISH_COMMON_DIR}getImages
echo "done!"

#echo "Customizing the target directory."
#./targetify
#echo "done!"

echo "Building the rootfs image."
if [ ! -d "./rootfs" ]; then
    mkdir ./rootfs
fi
if [ ! -d "./targetAux" ]; then
    mkdir ./targetAux
fi
#echo "Building the ubifs image."
#sudo ./mkubifs
if [ -n "$EMMC_ROOTFS" ] && [ "$EMMC_ROOTFS" -ne 0 ]
then
	:
else
	cp -p $PROJECT_IMAGES/fluke-full-image-${PROJECT_MACHINE}.ubi ./rootfs/ubi.img
fi

echo "Building composite flash images."
if [ -n "$EMMC_ROOTFS" ] && [ "$EMMC_ROOTFS" -ne 0 ]
then
	/usr/bin/srec_cat \
	./loader/U-boot/u-boot-with-spl.sfp -Binary \
	./DeviceTree/zImage-${PROJECT_NAME}_soc.dtb -Binary -Offset 0x00110000 \
	./kernel/zImage -Binary -Offset 0x00200000 \
	./fpga/${PROJECT_NAME}_OG.rbf -Binary -Offset 0x00800000 \
	./kernel/fluke-initrd-image-${PROJECT_MACHINE}.ext4.gz -Binary -Offset 0x01000000 \
	./loader/U-boot/u-boot-with-spl.sfp -Binary -Offset 0x02000000 \
	./DeviceTree/zImage-${PROJECT_NAME}_soc.dtb -Binary -Offset 0x02110000 \
	./kernel/zImage -Binary -Offset 0x02200000 \
	./fpga/${PROJECT_NAME}_OG.rbf -Binary -Offset 0x02800000 \
	./kernel/fluke-initrd-image-${PROJECT_MACHINE}.ext4.gz -Binary -Offset 0x03000000 \
	-Output ./rootfs/U10.flash -Motorola --address-length=4 -Data_Only
else
	/usr/bin/srec_cat \
	./loader/U-boot/u-boot-with-spl.sfp -Binary \
	./DeviceTree/zImage-${PROJECT_NAME}_soc.dtb -Binary -Offset 0x00110000 \
	./kernel/zImage -Binary -Offset 0x00200000 \
	./fpga/${PROJECT_NAME}_OG.rbf -Binary -Offset 0x0800000 \
	-Output ./rootfs/U10.flash -Motorola --address-length=4 -Data_Only
fi

# Create binary image from Motorola S-Record.  Fill blank spaces
# with 0xff instead of 0x00.
/usr/bin/srec_cat ./rootfs/U10.flash -Motorola \
-Fill 0xff -over ./rootfs/U10.flash \
-Output ./rootfs/U10.bin -Binary
echo "U10 done!"
if [ -n "$EMMC_ROOTFS" ] && [ "$EMMC_ROOTFS" -ne 0 ]
then
	echo "Using EMMC, skipping U11"
else
	/usr/bin/srec_cat \
	./rootfs/ubi.img -Binary \
	-Output ./rootfs/U11.flash -Motorola --address-length=4 -Data_Only
	/usr/bin/srec_cat ./rootfs/U11.flash -Motorola \
	-Fill 0xff -over ./rootfs/U11.flash \
	-Output ./rootfs/U11.bin -Binary
	echo "U11 done!"
fi
echo "Composite images created!"


if [ -z "$SKIP_PMENGR_GROUP" ] || [ "$SKIP_PMENGR_GROUP" -eq 0 ]  
then
	echo "Setting image permissions."
	if [ -n "$EMMC_ROOTFS" ] && [ "$EMMC_ROOTFS" -ne 0 ]
	then
		:
	else
		chmod 666 ./rootfs/ubi.img
		chgrp pmengr ./rootfs/ubi.img
		chgrp pmengr ./rootfs/U11.bin
	fi
	chgrp pmengr ./kernel/zImage
	chgrp pmengr ./rootfs/U10.bin
	echo "done!"
fi

BUILD_DATE=$(date +"%y_%m_%d")
RELEASE_FOLDER=${BUILD_DATE}_${PROJECT_NAME}
echo "Building release folder "$RELEASE_FOLDER

install -d ./release/$RELEASE_FOLDER/toolchain
install -d ./release/$RELEASE_FOLDER/zImage
install -d ./release/$RELEASE_FOLDER/rootfs
install -d ./release/$RELEASE_FOLDER/fpga
install -d ./release/$RELEASE_FOLDER/U10
install -d ./release/$RELEASE_FOLDER/U11
install -d ./release/$RELEASE_FOLDER/loader
#install -d ./release/$RELEASE_FOLDER/devicetree

cp -Rp ./toolchain/* ./release/${RELEASE_FOLDER}/toolchain/ 
cp -Rp ./DeviceTree ./release/${RELEASE_FOLDER}/.
cp -Rp ./loader ./release/${RELEASE_FOLDER}/.
cp -p ./kernel/zImage ./release/${RELEASE_FOLDER}/zImage/. 
if [ -n "$EMMC_ROOTFS" ] && [ "$EMMC_ROOTFS" -ne 0 ]
then
	cp -p $PROJECT_IMAGES/fluke-full-image-${PROJECT_MACHINE}.wic.gz ./release/${RELEASE_FOLDER}/rootfs/
	cp -p ./kernel/fluke-initrd-image-${PROJECT_MACHINE}.ext4.gz ./release/${RELEASE_FOLDER}/zImage/.
else
	cp -p ./rootfs/ubi.img ./release/${RELEASE_FOLDER}/rootfs/. 
	cp -p ./rootfs/U11.bin ./release/${RELEASE_FOLDER}/U11/. 
fi
cp -p ./rootfs/U10.bin ./release/${RELEASE_FOLDER}/U10/. 
cp -p ./fpga/* ./release/${RELEASE_FOLDER}/fpga/.
